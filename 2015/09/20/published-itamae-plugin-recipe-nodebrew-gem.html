<!DOCTYPE html><html><head><title>dev.toihrk.me</title><link href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css" rel="stylesheet" type="text/css"><link href="/layout.css" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><link href="/github-markdown.css" rel="stylesheet" type="text/css"><link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css" rel="stylesheet" type="text/css"><link href="/page.css" rel="stylesheet" type="text/css"><link href="/2015/09/20/published-itamae-plugin-recipe-nodebrew-gem.html" rel="canonical"><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js" type="text/javascript"></script></head><body><header class="pure-u-1-1"><a href="/"><h1>dev.toihrk.me</h1></a></header><div id="articleContainer"><article><div class="publish-date"><time datetime="2015-09-20" pubdate><span class="date-year"><a href="/archives/2015.html">2015</a>/</span><span class="date-month"><a href="/archives/2015-09.html">09</a>/</span><span class="date-day">20</span></time></div><div class="markdown-body"><h1 id="-itamae-nodebrew-2015-09-20-published-itamae-plugin-recipe-nodebrew-gem-html-"><a href="/2015/09/20/published-itamae-plugin-recipe-nodebrew-gem.html">ItamaeでNodebrewが入るレシピを書いた</a></h1>
<p><a href="https://rubygems.org/gems/itamae-plugin-recipe-nodebrew">itamae-plugin-recipe-nodebrew | RubyGems.org | your community gem host</a></p>
<p><a href="https://github.com/toihrk/itamae-plugin-recipe-nodebrew">toihrk/itamae-plugin-recipe-nodebrew</a></p>
<p>スターお願いします。</p>
<h2 id="special-thanks">Special Thanks</h2>
<p><a href="https://github.com/rutan/itamae-plugin-recipe-rtn_rbenv">rutan/itamae-plugin-recipe-rtn_rbenv</a></p>
<p>というか、モロパクリでVagrantのボックスのイメージも利用の許可を頂きました。</p>
<h2 id="itamae-">Itamaeのレシピを書く</h2>
<p>DSLを定義していくイメージで、いろいろなものをItamaeが提供してくれてるので簡単に書ける。</p>
<p>HubotでChatopsをしようっていう思惑でNode.jsが動く環境をAWS上に立てたくて、開発環境でも使ってるNodebrewが使えたら楽だな〜という感じで作った。</p>
<h2 id="nodebrew-">Nodebrew悩みどころ</h2>
<p><a href="https://github.com/hokaccha/nodebrew">hokaccha/nodebrew</a></p>
<p>そもそもシングルユーザーで使われることを想定しているようでREADMEには<code>$HOME</code>以下に本体である<code>.nodebrew</code> が作られるようなインストールの方法が目に入る。</p>
<p>できれば今回のレシピではシングルユーザー用のレシピとは別に本番で使うためにシステムにrbenvみたいなイメージで<code>/usr/local</code>以下にインストールするレシピも書きたかった。一応環境変数でインストール先のディレクトリを変更できるようになってるみたいで、それでもどういう挙動をするのかわからなかったのでそこを検証するところから始めた。</p>
<p>ひとまず動いてるようには確認できたけれど、バージョンの切り替えにはパーミッションが必要なようで、そこには<code>sudo</code>を使うようにserverspecで書いた。</p>
<p>rbenvみたいに細かな設定ができないようだけれど、そこはいいかなって印象で、ひとまず自分の使いたいように書けたので何か困ったらプルリクくれって感じ。</p>
<h2 id="vagrant-bundler-">VagrantとBundlerでハマる</h2>
<p>テストにはVagrantを使っていて、Vagrantの<code>1.7.4</code>ではBundlerの<code>1.10.6</code>は使えない。</p>
<p><a href="https://github.com/mitchellh/vagrant/issues/6072">Bundler 1.10.6 · Issue #6072 · mitchellh/vagrant</a></p>
<p>次のアップデートいつだよみたいな感じで、ひとまず動くようにと思ってBundlerの<code>1.10.5</code>をインストールしてテストは以下のように実行した。</p>
<pre><code>$ bundle _1.10.5_ exec rake spec
</code></pre><p>そこでとりあえずgemspecのdependencyのバージョンも下げた。</p>
<p><a href="https://github.com/toihrk/itamae-plugin-recipe-nodebrew/commit/a22ce3c7bbf4569402ac8ca139066625e55f62e5">modify gemspec bundler version · toihrk/itamae-plugin-recipe-nodebrew@a22ce3c</a></p>
<h2 id="-">所感</h2>
<p>VagrantのVMを4つも立ち上げたり殺したりしながらテストをしてたから思ったより時間がかかってしまったけれど、ちゃんとrubygemsに出せて良かった。</p>
</div><div class="btns"><a id="issue" href="https://github.com/toihrk-me/dev-blog/issues" data-icon="octicon-issue-opened" data-style="mega" data-count-api="/repos/toihrk-me/dev-blog#open_issues_count" data-count-aria-label="# issues on GitHub" aria-label="Issue toihrk-me/dev-blog on GitHub" class="github-button">Issue</a></div><script src="/page.js" type="text/javascript"></script></article></div><footer class="pure-u-1-1"><ul><li><a href="https://github.com/toihrk-me/dev-blog" data-icon="octicon-eye" data-count-href="/toihrk-me/dev-blog/watchers" data-count-api="/repos/toihrk-me/dev-blog#subscribers_count" data-count-aria-label="# watchers on GitHub" aria-label="Watch toihrk-me/dev-blog on GitHub" class="github-button">Watch</a></li><li><a href="https://github.com/toihrk-me/dev-blog" data-icon="octicon-star" data-count-href="/toihrk-me/dev-blog/stargazers" data-count-api="/repos/toihrk-me/dev-blog#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star toihrk-me/dev-blog on GitHub" class="github-button">Star</a></li><li><a href="https://github.com/toihrk" aria-label="Follow @toihrk on GitHub" class="github-button">Follow @toihrk</a></li></ul><ul><li><a href="/archives" class="button">Archives</a></li><li><a href="http://toihrk.me" class="button">About me</a></li><li><span id="copyright">&copy; 2015 toihrk. All rights reserved.</span></li></ul><script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script></footer></body></html>